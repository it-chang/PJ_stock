<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excel 成長率與連續上升範例</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.10/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.10/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div id="app">
    <v-app>
      <v-container style="max-width: 95%;">
        <v-data-table disable-pagination fixed-header height="90vh" hide-default-footer :headers="headers"
          :items="jsonData" :items-per-page="-1" style="white-space: nowrap;">
          <!-- 自訂數值欄位，含成長率顯示 -->
          <template
            v-for="header in headers.filter(h => h.value !== 'Typelevel' && h.value !== 'desc' && h.value !== 'Flag_連3日正成長')"
            v-slot:[`item.${header.value}`]="{ item }" :key="header.value">
            <span :style="{ color: item[header.value] >= 0 ? 'red' : 'blue' }">
              {{ parseFloat(item[header.value]).toFixed(1) }}
              <template v-if="item['成長率_' + header.value] !== null">
                <small :style="{ color: item['成長率_' + header.value] >= 0 ? 'red' : 'blue' }">
                  ({{ item['成長率_' + header.value] >= 0 ? '▲' : '▼' }}{{ Math.abs(item['成長率_' + header.value]).toFixed(1)
                  }}%)
                </small>
              </template>
            </span>
          </template>

          <!-- 顯示 Flag_連3日正成長 -->
          <template v-slot:item.Flag_連3日正成長="{ item }">
            <v-chip :color="item.Flag_連3日正成長 ? 'green' : 'grey'" small>
              {{ item.Flag_連3日正成長 ? '✓ 是' : '✗ 否' }}
            </v-chip>
          </template>
          <template v-slot:item.desc="{ item }">
            太陽
            <a :href="computedHref(item)" target="_blank" rel="noopener">
              {{ sanitizedTypelevel(item) }}
            </a>
            分類
            <a :href="computedHref2(item)" target="_blank" rel="noopener">
              {{ sanitizedTypelevel(item) }}
            </a>
          </template>
        </v-data-table>
      </v-container>
    </v-app>
  </div>

  <script>
    var app = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data() {
        return {
          headers: [],
          jsonData: []
        };
      },
      methods: {
        sanitizedTypelevel(x) {
          return x.Typelevel.replace('右上', '').replace('平', '').replace('右下', '');
        },
        computedHref(x) {
          const baseUrl = window.location.href.split('/').slice(0, 4).join('/'); // 取得當前網站的根網址
          return `${baseUrl}/index2.html?d=type&type=${this.sanitizedTypelevel(x)}`;
        },
        computedHref2(x) {
          const baseUrl = window.location.href.split('/').slice(0, 4).join('/'); // 取得當前網站的根網址
          return `${baseUrl}/index3.html?d=A&date=${Object.keys(this.jsonData[0]).slice(-2)[0]}&type=${this.sanitizedTypelevel(x)}`;
        },
        isNumberField(field) {
          return field !== 'stock_number' && this.jsonData.some(item => {
            const val = item[field];
            return val != null && !isNaN(parseFloat(val)) && isFinite(val);
          });
        }
      },
      async created() {
        const file = './Result/analyze_2.xlsx'; // ← 你的檔案路徑
        const response = await fetch(file);
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // 建 headers
        this.headers = json[0].map(h => ({ text: h, value: h }));
        this.headers.push({ text: 'Flag_連3日正成長', value: 'Flag_連3日正成長' });
        this.headers.push({ text: 'desc', value: 'desc' })

        // 轉換資料為物件陣列
        this.jsonData = json.slice(1).map(row => {
          const rowData = {};
          this.headers.forEach((header, i) => {
            rowData[header.value] = row[i];
          });
          return rowData;
        });


        this.jsonData.forEach(row => {
          this.headers.forEach((header, i) => {
            const key = header.value;
            const prevHeader = this.headers[i - 1]?.value;
            if (i > 0 && this.isNumberField(key) && this.isNumberField(prevHeader)) {
              const current = parseFloat(row[key]);
              const prev = parseFloat(row[prevHeader]);
              row['成長率_' + key] = (isFinite(current) && isFinite(prev) && prev !== 0)
                ? ((current - prev) / Math.abs(prev)) * 100
                : null;
            }
          });
        });

        // 計算 Flag_連3日正成長

       
        this.jsonData.forEach(row => {
          // 取得數值欄位（排除非數字與特別欄位）
          const valueHeaders = this.headers
            .map(h => h.value)
            .filter(key => this.isNumberField(key) && !key.startsWith('成長率_') && key !== 'Flag_連3日正成長');

          // 取最後三欄
          const last3 = valueHeaders.slice(-3);

          const g1 = row['成長率_' + last3[0]];
          const g2 = row['成長率_' + last3[1]];
          const g3 = row['成長率_' + last3[2]];

          const v1 = row[last3[0]];
          const v2 = row[last3[1]];
          const v3 = row[last3[2]];
          

          if (
            [g1, g2, g3].every(g => g !== null && g > 0) &&
            [v1, v2, v3].every(v => v !== null && parseFloat(v) > 0)
          ) {
            row['Flag_連3日正成長'] = true;
          } else {
            row['Flag_連3日正成長'] = false;
          }
        });
      }
    });
  </script>
</body>

</html>